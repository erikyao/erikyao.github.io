---
layout: post
title: "R Metaprogramming"
description: "Digest of Part IV, in-progress 2nd Edition of <i>Advanced R</i>"
category: 
tags: []
---
{% include JB/setup %}

P.S. 2nd Edition of _Advanced R_ is still in-progress. May update in the future.

# [Part IV - Metaprogramming](https://adv-r.hadley.nz/meta.html)

我觉得这部分主要解决的一个大问题就是：有引号和没引号的区别？比如：

- 为何 `library(purrr)` 和 `library("purrr")` 都可以？
- 为何 `plot(x, y)` 它知道 x-label 是 string `"x"`, y-label 是 string `"y"`?
- 为何 `dplyr:select(df, x)` 的 `x` 不用写引号？ 你这里 `x` 又不是 variable

然后 Non-Standard Evalution (NSE) 这个词有点 misleading。它的 non-standard 并不是说它 evaluation 的**结果**, 并不是说 standard 是 evaluate 成 5 你 non-standard 就 evaluate 成 6，而是指 evaluation 的**场合**：你自己手动去 evaluate 的，不是 interpreter 自己去 evaluate 的，那就是 non-standard evaluation。

Big ideas: (回头筛选；画图)

* Code is data; captured code is called an expression.
* Code has a tree-like structure called an abstract syntax tree.
* Expressions can be generated by code.
* Evaluation executes an expression in an environment.
* Evaluation can be customised by modifying or overriding the environment.
* Data masks blur environments and data frames.
* A quosure captures an expression with its environment.

base::quote()
base::bquote()
base::enquote()
base::substitute()

rlang::expr()
rlang::enexpr()

dplyr::expr()
dplyr::enexpr()
dplyr::quo()
dplyr::enquo()

## 预备知识：`class()` / `typeof()` / `mode()` / `storage.mode()`

[Stack Overflow: Mode, Class and Type of R objects](https://stats.stackexchange.com/a/3213) 曰：

- `class()` 是 OO 的角度
- `typeof()` 是 R language 的角度
- `mode()` 是 S language 的角度
- `storage.mode()` 是 compiled S 的角度

我只想说：Go fxxk yourself.

[Stack Overflow: A comprehensive survey of the types of things in R; 'mode' and 'class' and 'typeof' are insufficient](https://stackoverflow.com/a/40171527) 有大善人做了个表 (我调了一下 column 的顺序，把 `mode` 和 `storage.mode` 搁一起了)：


|spoken type         |class       |typeof      |mode        |storage.mode |
|:-------------------|:-----------|:-----------|:-----------|:------------|
|logical vector      |logical     |logical     |logical     |logical      |
|integer vector      |integer     |integer     |numeric     |integer      |
|numeric vector      |numeric     |double      |numeric     |double       |
|complex vector      |complex     |complex     |complex     |complex      |
|character vector    |character   |character   |character   |character    |
|raw vector          |raw         |raw         |raw         |raw          |
|factor              |factor      |integer     |numeric     |integer      |
|logical matrix      |matrix      |logical     |logical     |logical      |
|numeric matrix      |matrix      |double      |numeric     |double       |
|logical array       |array       |logical     |logical     |logical      |
|numeric array       |array       |double      |numeric     |double       |
|list                |list        |list        |list        |list         |
|pairlist            |pairlist    |pairlist    |pairlist    |pairlist     |
|data frame          |data.frame  |list        |list        |list         |
|closure function    |function    |closure     |function    |function     |
|builtin function    |function    |builtin     |function    |function     |
|special function    |function    |special     |function    |function     |
|environment         |environment |environment |environment |environment  |
|null                |NULL        |NULL        |NULL        |NULL         |
|formula             |formula     |language    |call        |language     |
|expression          |expression  |expression  |expression  |expression   |
|call                |call        |language    |call        |language     |
|name                |name        |symbol      |name        |symbol       |
|paren in expression |(           |language    |(           |language     |
|brace in expression |{           |language    |call        |language     |
|S3 lm object        |lm          |list        |list        |list         |
|S4 dummy object     |dummy       |S4          |S4          |S4           |
|external pointer    |externalptr |externalptr |externalptr |externalptr  |

我只想说：Go fxxk yourself.

有用的地方也不是没有，比如：

- 实力说明 `data.frame` 的本质是 `list`
- 实力说明 `name` 其实就是 `symbol`

## 预备知识：R Basic Types

[R Language Definition](https://cran.r-project.org/doc/manuals/r-patched/R-lang.html#Basic-types) 曰 Basic Types 有：

- Vector
- List
- **Language object**:
    - `expression` object:
        - > Since R has objects of type `expression` we will try to avoid the use of the word expression in other contexts. In particular syntactically correct expressions will be referred to as **statements**.
            - 为了区分，后面程序语言层面的 expression 就不用特殊格式，类型 `expression` 一定带格式
        - An expression contains one or more statements. 
        - A statement is a syntactically correct collection of tokens. 
        - `base::expression()`：接收一个 (程序语言层面的) expression (不是字符串)，返回一个 `expression` object
            - 比如 `base::expression(x + y, z - 100)` $\Rightarrow$ `expression(x + y, z - 100)` (这是个包含两个 statements 的 expression)
                - 注意：只有 `expression` object 有这样 `expression(...)` 格式化的输出；`call` object 和 `name` object 都没有
    - `call` object:
        - `base::call()`：接收一个符串 (后续可跟参数)，生成 `call` object 
            - 比如 `base::call("foo")` $\Rightarrow$ `call` object `foo()`
            - 注意这是个 `call` object 而不是一个 `function` object
            - 带参数的情况：`base::call("foo"， 2)` $\Rightarrow$ `call` object `foo(2)`
                - 等价于 `base::quote(foo(2))`
        - `base::quote()`：接收一个 function call statement，生成 `call` object 
            - 比如 `base::quote(foo())` $\Rightarrow$ `call` object `foo()`
            - 注意 `foo()` 是一个 function call statement 而 `foo` 是一个 name statement
    - `name` object:
        - Symbols refer to R objects. 
        - The name of any R object is usually a symbol. 
        - **不存在** `base::name()` 这么一个 function
        - `base::as.name()`：接收一个字符串，生成一个 `name` object 
            - 比如 `base::as.name("x")` $\Rightarrow$ `name` object `x`
        - `base::quote()`：接收一个 name statement，生成 `name` object 
            - 比如 `base::quote(x)` $\Rightarrow$ `name` object `x`
- Function
- `NULL`
- Builtin objects and special forms:
    - 主要指通过 `.Primitive()` 或者 `.Internal()` 实现的函数，分两类：
        - Builtin functions have all their arguments evaluated and passed to the internal function, in accordance with call-by-value, whereas special functions pass the unevaluated arguments to the internal function.
   



<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Erik Yao's Java 多线程：synchronized</title>
    <meta name="description" content="">
    <meta name="author" content="Erik Yao">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/css/1.4.0/bootstrap.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  
    <link rel="shortcut icon" href="/favicon.ico">
  <!-- Update these with your own images
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
	<link href="/assets/themes/twitter/google-code-prettify/prettify.css" rel="stylesheet" type="text/css" media="all">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/themes/twitter/google-code-prettify/prettify.js"></script>
	<script type="text/javascript" src="/assets/themes/twitter/google-code-prettify/use-prettify.js"></script>
  </head>

  <body>

    <div class="topbar">
      <div class="fill">
        <div class="container">
          <a class="brand" href="/">Erik Yao's</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/index.html">Home</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        
<div class="page-header">
  <h1>Java 多线程：synchronized <small></small></h1>
</div>

<div class="row">
  <div class="span10">
    <p>　　首先明确一点，同步方法本质上也是一个同步控制块（仅针对于锁定 this 的情况，如果同步控制块锁定的不是 this，那么它是不能直接改写为同步方法的），区别在于同步方法的粒度是整个方法，而同步控制块的粒度可以是方法的一部分。</p>

<pre class="prettyprint linenums">
// 同步方法示例  
public class Counter {  
    int count;  
    static int classCount;  
      
    public synchronized void bump() {  
        System.out.println("bump() starts");  
        count++;  
        try {  
            Thread.sleep(1000);  
        } catch (InterruptedException e) {  
            e.printStackTrace();  
        }  
        System.out.println("bump() ends");  
    }  
      
    public static synchronized void classBump() {  
        classCount++;  
        System.out.println("classBump()");  
    }  
}  
  
// 同步方法可以等价地写成同步控制块  
public class Counter {  
    int count;  
    static int classCount;  
      
    public void bump() {  
        synchronized (this) {  
            // ...  
        }  
    }  
      
    public static void classBump() {  
        synchronized (Counter.class) {  
            // ...  
        }  
          
        // 或者不用Counter.class，用Class.forName()  
        /** 
        try { 
            synchronized (Class.forName("Counter")) { 
                // ... 
            } 
        } catch (ClassNotFoundException e) { 
            e.printStack(); 
        } 
        */  
    }  
}  
</pre>


<p>　　从这个例子可以看出，Class 锁（针对 static 方法）和 Object 锁（针对非 static 方法）是两种锁。从实验的结果来看，这两种锁是不冲突的，即：假设有 Counter c = new Counter();，如果 Thread A 调用 c.bump() 方法，那么 synchronized(this) 只是锁定了 c 这个对象，Thread B 可以无所顾忌地调用 Counter.classBump()（或者 c.classBump() 也可以），不用等待 Thread A 释放 c 的锁。如：</p>

<pre class="prettyprint linenums">
public class MultiThreadTest8 {  
    public static void main(String[] args) {  
        final Counter c = new Counter();  
          
        Thread t1 = new Thread(  
                new Runnable() {  
                    @Override public void run() {  
                        c.bump();  
                    }  
                }, "Runner 1");  
          
        Thread t2 = new Thread(  
                new Runnable() {  
                    @Override public void run() {  
                        //Counter.classBump();  
                        c.classBump();  
                    }  
                }, "Runner 2");  
          
        t1.setPriority(Thread.NORM_PRIORITY + 2);  
        t1.start();  
        t2.start();  
          
        // output:   
        /** 
            bump() starts 
            classBump() 
            bump() ends      
        */  
    }  
}  
</pre>


<p>　　不过一旦 Thread A 调用 c.bump()，锁定了 c，那么 Thread B 就不能调用 c.bump() 了，c 中的其他同步方法或是同步控制块 Thread B 也不能访问，只有等到 Thread A 释放 c 的锁（即 c.bump() 同步部分执行完）。Counter 的非同步方法不受锁的限制，即使 Thread A 锁定了 c，Thread B 也可以随意访问 c 的非同步方法。</p>

<p><br/></p>

<p><em>p.s.</em> 这里说锁定一个对象，并不是说属性不能访问，锁定对象只是锁定同步方法或是同步控制块，使同步方法或是同步控制块的执行不会被其他线程打断（可以理解为：锁定方法到一个线程）。如果有一个同步方法去修改某个字段，此时是可以有另一个非同步方法也去修改这个字段，这样仍然有可能产生数据不一致的情况。</p>

<p><em>p.s.</em> synchronized 关键字可以放在类的前面，表示类中的所有方法都是同步方法。</p>

    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/java/2010/10/04/runnable-vs-thread" title="Java 多线程：Runnable 接口 v.s. Thread 类">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/java/2010/10/10/main-method" title="有关 Java 的 main 方法">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    
  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>05 October 2010</span></div>
	
  <br/>
	
  
    <h4>Categories</h4>
	<ul class="tag_box">
	
	


  
     
    	<li><a href="/categories.html#java-ref">
    		java <span>40</span>
    	</a></li>
    
  


	</ul>
    

  
    <h4>Tags</h4>
    <ul class="tag_box">
    
    


  
     
    	<li><a href="/tags.html#Java-101-ref">Java-101 <span>49</span></a></li>
     
    	<li><a href="/tags.html#Java-Concurrent-ref">Java-Concurrent <span>3</span></a></li>
    
  



    </ul>
    
  </div>
</div>


      </div>

      <footer>
        <p>&copy; Erik Yao 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
  </body>
</html>


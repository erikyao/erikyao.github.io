
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Erik Yao's Spring MVC example anatomy</title>
    <meta name="description" content="">
    <meta name="author" content="Erik Yao">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/css/1.4.0/bootstrap.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">

    <!-- Le fav and touch icons -->
  
    <link rel="shortcut icon" href="/favicon.ico">
  <!-- Update these with your own images
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
	<link href="/assets/themes/twitter/google-code-prettify/prettify.css" rel="stylesheet" type="text/css" media="all">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/assets/themes/twitter/google-code-prettify/prettify.js"></script>
	<script type="text/javascript" src="/assets/themes/twitter/google-code-prettify/use-prettify.js"></script>
  </head>

  <body>

    <div class="topbar">
      <div class="fill">
        <div class="container">
          <a class="brand" href="/">Erik Yao's</a>
          <ul class="nav">
            
            
            


  
    
      
      	
      	<li><a href="/index.html">Home</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/archive.html">Archive</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/categories.html">Categories</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/tags.html">Tags</a></li>
      	
      
    
  
    
      
      	
      	<li><a href="/pages.html">Pages</a></li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  



          </ul>
        </div>
      </div>
    </div>

    <div class="container">

      <div class="content">
        
<div class="page-header">
  <h1>Spring MVC example anatomy <small></small></h1>
</div>

<div class="row">
  <div class="span10">
    <p>　　例子来自 <a href="http://docs.spring.io/docs/Spring-MVC-step-by-step/">Developing a Spring Framework MVC application step-by-step</a> ，版本是 spring-framework-2.5.6.SEC01</p>

<p><img src="https://vglspw.bn1302.livefilestore.com/y2pOqlFuqZyXLFlJfv0gXblKqxagQbcr7q7m0Ok6K3IrlR5ASHfxU8KdC4B4SbgdqbGQ7FBWXvm_oPdllMV58coth-82QQ37kv7lwqXng5L-_o/e52c303a-e30c-34e1-a55a-b707d881a99a.png?psid=1" alt="" /></p>

<h2>1. DispatchServlet 接过浏览器的 /hello.htm请求</h2>

<p>　　在 springapp/war/WEB-INF/web.xml 中，定义了homepage：</p>

<pre><code class="xml">&lt;welcome-file-list&gt;
    &lt;welcome-file&gt;index.jsp&lt;/welcome-file&gt;
&lt;/welcome-file-list&gt;
</code></pre>

<p>所以 http://localhost:8080/springapp 即相当于 http://localhost:8080/springapp/index.jsp。</p>

<p>　　而 springapp/war/index.jsp 是直接 sendRedirect：</p>

<pre><code class="html">&lt;%-- Redirected because we can't set the welcome page to a virtual URL. --%&gt;
&lt;c:redirect url="/hello.htm"/&gt;
</code></pre>

<p>所以又转到 http://localhost:8080/springapp/hello.htm</p>

<p>　　在 springapp/war/WEB-INF/web.xml 中有：</p>

<pre class="prettyprint linenums">
&lt;servlet&gt;  
    &lt;servlet-name&gt;springapp&lt;/servlet-name&gt;  
    &lt;servlet-class&gt;org.springframework.web.servlet.DispatcherServlet&lt;/servlet-class&gt;  
&lt;/servlet&gt;  
  
&lt;servlet-mapping&gt;  
    &lt;servlet-name&gt;springapp&lt;/servlet-name&gt;  
    &lt;url-pattern&gt;*.htm&lt;/url-pattern&gt;  
&lt;/servlet-mapping&gt;
</pre>


<p>所以这个 http://localhost:8080/springapp/hello.htm 请求由 DispatcherServlet 来处理。</p>

<hr />

<h2>2. DispatchServlet 确定 mapping of &lt;Request, Controller></h2>

<p>　　DispatchServlet 默认使用的是 BeanNameUrlHandlerMapping，即通过 controller 的 bean name 来与 request 对应。</p>

<p>　　Controller 在 WebApplicationContext 文件中定义，而 WebApplicationContext 文件的命名规则是 &lt;servlet-name&gt;-servlet.xml，所以本案例的 WebApplicationContext 文件即是 springapp-servlet.xml。</p>

<p>　　bean name 必须是 slash 开头，然后只能写 request 中最后一个 slash 后面的部分。</p>

<pre><code class="xml">&lt;bean name="/hello.htm" class="springapp.web.InventoryController"&gt;  
    &lt;property xxx="zzz"&gt;&lt;/property&gt;  
&lt;/bean&gt; 
</code></pre>

<p>　　另外还有 SimpleUrlHandlerMapping、ControllerClassNameHandlerMapping 和 CommonsPathMapHandlerMapping 三种 mapping 形式，这里就不展开了。</p>

<hr />

<h2>3. Controller 返回 ModelAndView 给 DispatchServlet</h2>

<p>　　Controller 的类型有很多，最简单的形式就是自己实现一个 Controller 接口 (spring 自带了很多 Controller 及其子接口的实现)，只需实现一个 handleRequest(HttpServletRequest, HttpServletResponse) 方法，返回一个 ModelAndView 即可。</p>

<p>　　ModelAndView(viewName, modelName, modelObject)，其中的 modelName 和 modelObject 是一个 pair；viewName 可以写一个长路径，如 “WEB-INF/jsp/hello.jsp”，更常见的方法是返回一个短字符串，比如 "hello"，交给 ViewResolver 去解析。</p>

<hr />

<h2>4. DispatchServlet 通过 ViewResolver 来解析 ViewName</h2>

<p>　　DispatchServlet 默认使用的 ViewResolver 是 InternalResourceViewResolver (更多关于 DispatchServlet 的默认配置请参见 spring-framework-2.5.6.SEC01\src\org\springframework\web\servlet\DispatcherServlet.properties)，但与 BeanNameUrlHandlerMapping 不同的是，虽然 InternalResourceViewResolver 是默认的，但需要进一步对 InternalResourceViewResolver 进行配置。</p>

<pre class="prettyprint linenums">
&lt;!-- spingapp/war/WEB-INF/springapp-servlet.xml --&gt;  
  
&lt;bean id="viewResolver" class="org.springframework.web.servlet.view.InternalResourceViewResolver"&gt;  
    &lt;property name="viewClass" value="org.springframework.web.servlet.view.JstlView"&gt;&lt;/property&gt;  
    &lt;property name="prefix" value="/WEB-INF/jsp/"&gt;&lt;/property&gt;  
    &lt;property name="suffix" value=".jsp"&gt;&lt;/property&gt;  
&lt;/bean&gt;  
</pre>


<p>prefix + “hello” + suffix == "/WEB-INF/jsp/hello.jsp"</p>

<p>　　注意这里的 bean id，虽然在 spring-framework-2.5.6.SEC01\src\org\springframework\web\servlet\DispatcherServlet.java 里有：</p>

<pre class="prettyprint linenums">
public static final String VIEW_RESOLVER_BEAN_NAME = "viewResolver";  
</pre>


<p>但这里的bean id可以随便写。</p>

<p>　　However, MessageSource 类的 bean id 必须是 "messageSource"，不能随便写。我们在 spring-framework-2.5.6.SEC01\src\org\springframework\context\support\AbstractApplicationContext.java 里面可以看到有：</p>

<pre class="prettyprint linenums">
public static final String MESSAGE_SOURCE_BEAN_NAME = "messageSource";  
</pre>


<p>　　另外，bean name和bean id 的区别：</p>

<blockquote><p>Either one would work. It depends on your needs:
If your bean identifier contains special character(s) for example (/viewSummary.html), it (the slash) won't be allowed as the bean id, because it's not a valid XML ID. In such cases you could skip defining the bean id and supply the bean name instead.
The name attribute also helps in defining aliases for your bean, since it allows specifying multiple identifiers for a given bean.</p></blockquote>

<hr />

<h2>5. JSP dispatched to browser by DispatchServlet</h2>

<p>　　hello.jsp 被 dispatch 给浏览器显示，注意是 dispatch，所以浏览器的地址栏仍然是 hello.htm。</p>

<p>　　JSP 可以使用 ModelAndView 中的 Model，形式如 "${ModelName.ModelObject}"，类似于 getAttribute。</p>

<pre class="prettyprint linenums">
&lt;%-- springapp/war/WEB-INF/jsp/hello.jsp --%&gt;  
  
&lt;body&gt;  
    &lt;h1&gt;&lt;fmt:message key="heading"/&gt;&lt;/h1&gt;  
    &lt;p&gt;&lt;fmt:message key="greeting"/&gt; &lt;c:out value="${model.now}"&gt;&lt;/c:out&gt;&lt;/p&gt;  
    &lt;h3&gt;Product&lt;/h3&gt;  
    &lt;c:forEach items="${model.products}" var="prod"&gt;  
        &lt;c:out value="${prod.description}"/&gt;   
        &lt;i&gt;&lt;c:out value="${prod.price}"/&gt;&lt;/i&gt;&lt;br&gt;&lt;br&gt;  
    &lt;/c:forEach&gt;  
    &lt;br&gt;  
    &lt;a href="&lt;c:url value="priceincrease.htm"/&gt;"&gt;Increase Price&lt;/a&gt;  
    &lt;br&gt;  
&lt;/body&gt;  
</pre>


    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/spring/2009/11/17/dependency-di-and-ioc" title="依赖、依赖注入（DI）以及控制反转（IoC）">&larr; Previous</a></li>
      
        <li><a href="/archive.html">Archive</a></li>
      
        <li class="next"><a href="/hardware/2009/12/04/disk-driver" title="Disk Drive（磁盘驱动器）">Next &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    
  </div>
  
  <div class="span4">
    <h4>Published</h4>
    <div class="date"><span>29 November 2009</span></div>
	
  <br/>
	
  
    <h4>Categories</h4>
	<ul class="tag_box">
	
	


  
     
    	<li><a href="/categories.html#springmvc-ref">
    		springmvc <span>2</span>
    	</a></li>
    
  


	</ul>
    

  
    <h4>Tags</h4>
    <ul class="tag_box">
    
    


  
     
    	<li><a href="/tags.html#Config-ref">Config <span>11</span></a></li>
     
    	<li><a href="/tags.html#Config-SpringMVC-ref">Config-SpringMVC <span>2</span></a></li>
     
    	<li><a href="/tags.html#HowDoes-ref">HowDoes <span>5</span></a></li>
     
    	<li><a href="/tags.html#HowDoes-SpringMVC-ref">HowDoes-SpringMVC <span>2</span></a></li>
    
  



    </ul>
    
  </div>
</div>


      </div>

      <footer>
        <p>&copy; Erik Yao 2012 
          with help from <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          and <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
        </p>
      </footer>

    </div> <!-- /container -->

    
  </body>
</html>

